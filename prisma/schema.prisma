generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int              @id @default(autoincrement())
  firstName          String
  lastName           String
  email              String           @unique
  password           String
  role               Role             @default(STUDENT)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  isActive           Boolean          @default(false)
  passwordResetToken String?
  certificates       Certificate[]
  progress           CourseProgress[]
  lessonProgress     LessonProgress[]
  enrollments        Enrollment[]
  payments           Payment[]
  reviews            Review[]
  cart               Cart?
  orders             Order[]
  quizAttempts       QuizAttempt[]
  sessions           Session[]
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String
  courses     Course[]
}

model Cart {
  id        Int        @id @default(autoincrement())
  userId    Int        @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id       Int      @id @default(autoincrement())
  cartId   Int
  courseId Int
  cart     Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  addedAt  DateTime @default(now())

  @@unique([cartId, courseId]) // Prevent duplicate courses in the same cart
}

model Course {
  id               Int              @id @default(autoincrement())
  title            String           @unique
  description      String
  price            Float
  originalPrice    Float?
  status           CourseStatus     @default(DRAFT)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  categoryId       Int?
  thumbnail        String
  language         String[]
  whatYouWillLearn String[]
  averageRating    Float            @default(0)
  reviewCount      Int              @default(0)
  certificates     Certificate[]
  category         Category?        @relation(fields: [categoryId], references: [id])
  progress         CourseProgress[]
  enrollments      Enrollment[]
  payments         Payment[]
  reviews          Review[]
  sections         Section[]
  cartItems        CartItem[]
  orders           Order[]

  @@index([status, createdAt])    // Hot path: "Get published courses sorted by date"
  @@index([categoryId, status])   // Hot path: "Get published courses by category"
}

model Section {
  id       Int      @id @default(autoincrement())
  title    String
  courseId Int
  lessons  Lesson[]
  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  order    Int      @default(1)
  quize    Quize?
}

// Here Is All Schema For Smooth Quizzes That Belong to  Section one section contain only one Quize  and Quize  Contain  Many Questions And Thair  Option
model Quize {
  id        Int           @id @default(autoincrement())
  title     String
  sectionId Int           @unique
  section   Section       @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  questions Question[]
  attempts  QuizAttempt[]
}

model QuizAttempt {
  id        Int      @id @default(autoincrement())
  userId    Int
  quizId    Int
  score     Int // Percentage 0-100
  passed    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz      Quize    @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@unique([userId, quizId])
}

model Question {
  id      Int      @id @default(autoincrement())
  title   String
  quizeId Int
  options Option[]
  quize   Quize    @relation(fields: [quizeId], references: [id], onDelete: Cascade)
}

model Option {
  id         Int      @id @default(autoincrement())
  title      String
  isCorrect  Boolean  @default(false)
  questionId Int
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Lesson {
  id           Int              @id @default(autoincrement())
  title        String
  bunnyVideoId String
  duration     Int // stored as minutes 
  sectionId    Int
  resource     Resource[]
  progress     LessonProgress[]
  section      Section          @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  order        Int              @default(1)
}

model Resource {
  id       Int    @id @default(autoincrement())
  name     String
  url      String
  lessonId Int
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
}

model Enrollment {
  id        Int      @id @default(autoincrement())
  userId    Int
  courseId  Int
  createdAt DateTime @default(now())
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  payment   Payment?

  @@unique([userId, courseId])
  @@index([userId])       // Hot path: "Get user enrollments"
  @@index([courseId])     // Hot path: "Get course enrollees"
}

model Payment {
  id               Int             @id @default(autoincrement())
  amount           Float
  provider         PaymentProvider
  status           PaymentStatus   @default(PENDING)
  createdAt        DateTime        @default(now())
  userId           Int
  courseId         Int
  enrollmentId     Int             @unique
  orderId          Int             @unique
  gatewayPaymentId String?
  gatewaySignature String?
  course           Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  enrollment       Enrollment      @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  order            Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([userId])       // Hot path: "Get user payment history"
  @@index([status])       // Hot path: "Find pending payments"
}

model CourseProgress {
  id         Int    @id @default(autoincrement())
  userId     Int
  courseId   Int
  percentage Float  @default(0)
  course     Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])       // Hot path: "Dashboard - all user progress"
  @@index([courseId])     // Future: "Course completion analytics"
}

model LessonProgress {
  id             Int       @id @default(autoincrement())
  lessonId       Int
  userId         Int
  isComplete     Boolean   @default(false)
  watchedSeconds Int       @default(0)
  completedAt    DateTime?
  lesson         Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([lessonId, userId])
  @@index([userId, isComplete])  // Hot path: "Count completed lessons for progress calc"
  @@index([lessonId])            // Hot path: "Get all users who completed lesson"
}

model Certificate {
  id            Int      @id @default(autoincrement())
  certificateId String   @unique @default(uuid())
  userId        Int
  courseId      Int
  issuedAt      DateTime @default(now())
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])       // Hot path: "Get all user certificates"
}

model Review {
  id        Int      @id @default(autoincrement())
  rating    Int
  comment   String?
  userId    Int
  courseId  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId, createdAt])  // Hot path: "Get course reviews ordered by date"
}

model Order {
  id             Int             @id @default(autoincrement())
  userId         Int
  courseId       Int
  amount         Float
  currency       String          @default("INR")
  status         OrderStatus     @default(PENDING)
  gatewayOrderId String?         @unique
  provider       PaymentProvider
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @default(now()) @updatedAt
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  course         Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  payment        Payment?

  @@index([userId, status])       // Hot path: "Get user pending orders"
  @@index([userId, createdAt])    // Hot path: "Purchase history sorted by date"
  @@index([courseId])             //"Course sales analytics"
}

model AppSettings {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

enum Role {
  ADMIN
  STUDENT
}

enum PaymentProvider {
  RAZORPAY
  PHONEPE
  CASHFREE
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Session {
  id         String   @id @default(uuid())
  userId     Int
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
}
